import{au as i,av as a}from"./IEdULTv5.js";const h=()=>{const e=u();return{customFetch:async(o,s={})=>{let t=0;for(e.accessToken&&(s.headers={...s.headers,Authorization:`Bearer ${e.accessToken}`});;)try{return await $fetch(o,s)}catch(c){if(c.status===401&&t<1){t++;try{await e.refresh(),s.headers={...s.headers,Authorization:`Bearer ${e.accessToken}`};continue}catch(n){throw console.error("Failed to refresh token:",n),e.logout(),n}}else throw c}}}},u=i("user",{state:()=>({user:null,accessToken:null,refreshToken:null,isAuthenticated:!1}),persist:{storage:a.localStorage(),pick:["refreshToken","user","isAuthenticated"]},actions:{async login(e,r){const{customFetch:o}=h();try{const s=await o("/api/auth/login",{method:"POST",body:{username:e,password:r},credentials:"include"});this.user=s.user,this.accessToken=s.accessToken,this.refreshToken=s.refreshToken,this.isAuthenticated=!0}catch(s){throw console.error("Login failed:",s),s}},async googleLogin(e,r,o){const{customFetch:s}=h();try{const t=await s("/api/auth/googleAuth",{method:"POST",body:{googleId:e,email:r,name:o},credentials:"include"});this.user=t.user,this.accessToken=t.accessToken,this.refreshToken=t.refreshToken,this.isAuthenticated=!0}catch(t){throw console.error("Google login failed:",t),t}},async refresh(){if(console.log("[userStore] refresh called",{refreshToken:this.refreshToken,accessToken:this.accessToken,hasUser:!!this.user}),!this.refreshToken){console.warn("[userStore] refresh aborted: missing refreshToken"),this.logout();return}const{customFetch:e}=h();try{const r=await e("/api/auth/refresh",{method:"POST",body:{refreshToken:this.refreshToken},credentials:"include"});this.accessToken=r.accessToken,r.refreshToken&&(this.refreshToken=r.refreshToken),r.user&&(this.user=r.user),this.isAuthenticated=!!this.user,console.log("[userStore] refresh success",{user:this.user,accessToken:this.accessToken,refreshToken:this.refreshToken,isAuthenticated:this.isAuthenticated})}catch(r){throw console.error("Refresh failed:",r),this.logout(),r}},async checkAuth(){console.log("[userStore] checkAuth invoked",{isAuthenticated:this.isAuthenticated,hasUser:!!this.user,hasAccessToken:!!this.accessToken,hasRefreshToken:!!this.refreshToken}),this.refreshToken&&(!this.accessToken||!this.user)&&await this.refresh();const e=this.isAuthenticated&&!!this.user;return console.log("[userStore] checkAuth result",{result:e,user:this.user,accessToken:this.accessToken,refreshToken:this.refreshToken}),e},logout(){this.user=null,this.accessToken=null,this.refreshToken=null,this.isAuthenticated=!1}}});export{h as a,u};
