import { PrismaClient } from '@prisma/client'
import { defineEventHandler, createError } from 'h3'
import type { Conversation, Message } from '~/types/conversation'

const prisma = new PrismaClient()

// تابع کمکی برای تبدیل تاریخ به فرمت نسبی (دیروز، امروز)
const getRelativeDate = (date: Date): string => {
  const today = new Date()
  const yesterday = new Date(today)
  yesterday.setDate(today.getDate() - 1)

  const isToday = date.toDateString() === today.toDateString()
  const isYesterday = date.toDateString() === yesterday.toDateString()

  return isToday ? 'امروز' : isYesterday ? 'دیروز' : date.toLocaleDateString('fa-IR')
}

// تابع کمکی برای تبدیل تاریخ به فرمت زمان
const formatTime = (date: Date): string => {
  return date.toLocaleTimeString('fa-IR', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true,
  })
}

export default defineEventHandler(async (event) => {
  try {
    // دریافت userId از query
    const query = getQuery(event)
    const userId = query.userId ? parseInt(query.userId as string) : undefined

    // اعتبارسنجی userId
    if (!userId || isNaN(userId)) {
      throw createError({
        statusCode: 400,
        statusMessage: 'شناسه کاربر نامعتبر است',
      })
    }
    console.log('fetch starting: ...')
    // دریافت تمام مکالمات کاربر و پیام‌ها
    const chats = await prisma.chats.findMany({
      where: { userId },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            profilePicture: true, // جایگزین photo
          },
        },
        Messages: {
          orderBy: { createdAt: 'asc' },
          select: {
            id: true,
            content: true,
            isBotMessage: true,
            createdAt: true,
            apiResponse: true,
          },
        },
      },
    })

    // تبدیل داده‌ها به فرمت مورد نظر
    const conversations: Conversation[] = chats.map((chat) => {
      // گروه‌بندی پیام‌ها بر اساس تاریخ
      const messagesByDate = chat.Messages.reduce((acc, message) => {
        const dateKey = getRelativeDate(message.createdAt)
        if (!acc[dateKey]) {
          acc[dateKey] = []
        }
        acc[dateKey].push(message)
        return acc
      }, {} as Record<string, typeof chat.Messages>)

      // ایجاد آرایه پیام‌ها با جداکننده‌ها
      const messages: Message[] = []
      Object.keys(messagesByDate)
        .sort((a, b) => new Date(a).getTime() - new Date(b).getTime())
        .forEach((date) => {
          // افزودن جداکننده
          messages.push({
            type: 'separator',
            text: '',
            time: date,
            attachments: [],
          })

          // افزودن پیام‌ها
          messagesByDate[date].forEach((message) => {
            messages.push({
              type: message.isBotMessage ? 'received' : 'sent',
              text: message.content,
              time: formatTime(message.createdAt),
              attachments: message.apiResponse
                ? [
                    {
                      type: 'link',
                      image: '/img/apps/1.png', // باید داینامیک شود
                      url: 'https://example.com', // باید از apiResponse استخراج شود
                      text: 'پاسخ API',
                    },
                  ]
                : [],
            })
          })
        })
      // console.log('fetch end: ... ')
      // console.log('Messages: ... ', messages)
      return {
        id: chat.id,
        user: {
          name: chat.user.name ?? 'بدون نام',
          profilePicture: chat.user.profilePicture ?? '/img/avatars/default-other.jpg',
        },
        messages,
      }
    })

    return conversations
  }
  catch (error) {
    console.error('Error fetching conversations:', error)
    throw createError({
      statusCode: 500,
      statusMessage: 'خطا در دریافت مکالمات',
    })
  }
  finally {
    await prisma.$disconnect()
  }
})
